# Build Caddy: https://caddyserver.com/download?package=github.com%2Fcaddy-dns%2Fcloudflare
# Download caddy: https://caddyserver.com/api/download?os=linux&arch=amd64&p=github.com%2Fcaddy-dns%2Fcloudflare&idempotency=97941957140757

{
	# Global options block for settings that affect the whole Caddy server
	email {$PH_WAF_EMAIL}
	# Uncomment the following line if you need to enable logging
	log {
        output stdout
        format console
    }
    debug
}

# Redirect all HTTP traffic to HTTPS
http:// {
    redir https://{host}{uri}
}

(cors) {
	@options {
        method OPTIONS
    }
    handle @options {
		header Access-Control-Allow-Origin "*"
		header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE"
		header Access-Control-Allow-Headers "Content-Type, Authorization"
		respond "" 204
    }

    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "GET, POST, OPTIONS"
    header Access-Control-Allow-Headers "Content-Type, Authorization"
}

(healthcheck) {
    handle_path /_waf/health {
		header Content-Type application/json
        respond `{"status": "ok"}` 200
    }
}


{$MOTHERSHIP_NAME}.{$PH_EDGE_REGION}.{$APEX_DOMAIN} {
	import cors
	import healthcheck
	handle {
		reverse_proxy localhost:{$MOTHERSHIP_PORT}
	}

	handle_errors {
		respond "PocketHost mothership is temporarily unavailable. Use Discord for fastest support: {$DISCORD_INVITE_URL}" 500
	}
}

*.{$PH_EDGE_REGION}.{$APEX_DOMAIN} {
	tls {
		dns cloudflare {$PH_WAF_CF_API_TOKEN}
	}

	import cors
	import healthcheck

	handle {
		reverse_proxy localhost:{$DAEMON_PORT}

	}

	handle_errors {
		respond "PocketHost edge {$PH_EDGE_REGION} is temporarily unavailable. Use Discord for fastest support: {$DISCORD_INVITE_URL}" 500
	}
}

https:// {
	import healthcheck

	handle {
		respond "This is the {$PH_EDGE_REGION} edge of PocketHost. If you are trying to access an instance, use <instance>.{$PH_EDGE_REGION}.{$APEX_DOMAIN}" 403
	}
}
