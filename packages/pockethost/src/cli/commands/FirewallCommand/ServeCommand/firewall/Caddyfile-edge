{
	# Global options block for settings that affect the whole Caddy server
	email {$PH_WAF_EMAIL}
	# Uncomment the following line if you need to enable logging
	log {
        output stdout
        format console
    }
    debug
}

(cors) {
	@options {
        method OPTIONS
    }
    handle @options {
		header Access-Control-Allow-Origin "*"
		header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE"
		header Access-Control-Allow-Headers "Content-Type, Authorization"
		respond "" 204
    }

    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "GET, POST, OPTIONS"
    header Access-Control-Allow-Headers "Content-Type, Authorization"
}

(healthcheck) {
    handle_path /_waf/health {
		header Content-Type application/json
        respond `{"status": "ok"}` 200
    }
}

*.{$PH_EDGE_REGION_NAME}.{$APEX_DOMAIN} {
	tls {$SSL_CERT} {$SSL_KEY}

	import cors
	import healthcheck

	handle {
		reverse_proxy localhost:{$DAEMON_PORT}

	}

	handle_errors {
		respond "PocketHost edge {$PH_EDGE_REGION_NAME} is temporarily unavailable. Use Discord for fastest support: {$DISCORD_INVITE_URL}" 500
	}
}

{$PH_EDGE_REGION_NAME}.{$APEX_DOMAIN} {
	tls {$SSL_CERT} {$SSL_KEY}

	import healthcheck

	handle {
		respond "This is the {$PH_EDGE_REGION_NAME} edge of PocketHost. If you are trying to access an instance, use <instance>.{$PH_EDGE_REGION_NAME}.{$APEX_DOMAIN}" 403
	}
}
